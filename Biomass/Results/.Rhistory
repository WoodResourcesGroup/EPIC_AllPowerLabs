names(result.lemma)[names(result.lemma)=="x"] <- "Cent.x"
names(result.lemma)[names(result.lemma)=="y"] <- "Cent.y"
head(result.lemma)
merge
result.lemma <- data.frame()
for (i in 77:78) { # final: nrow(drought)
single <- drought[i,]
clip1 <- crop(LEMMA, extent(single))
clip2 <- mask(clip1, single)
ext <- extract(clip2, single) # extracts data from the raster - this value is the plot # of the raster cell, which corresponds to detailed data in the attribute table
tab <- lapply(ext, table) # creates a table that counts how many of each raster value there are in the polygon
s <- sum(tab[[1]]) # Counts total raster cells the polygon - this is different from length(clip2tg) because it doesn't include NAs
mat <- as.data.frame(tab)
mat2 <- as.data.frame(tab[[1]]/s) # Gives fraction of polygon occupied by each plot type. Adds up to 1 for each polygon.
mat2 <- merge(mat, mat2, by="Var1")
# extract attribute information from LEMMA for each plot number contained in the polygon:
L.in.mat <- subset(LEMMA@data@attributes[[1]], LEMMA@data@attributes[[1]][,"ID"] %in% mat[,1])[,c("ID","BAC_GE_3","BPHC_GE_3_CRM","TPHC_GE_3","QMDC_DOM","CONPLBA","TREEPLBA")]
# SKIP POLYGONS WITH NO CORRESPONDING RASTER DATA
if (is.na(L.in.mat[1,1])) {
next
}
merge <- merge(L.in.mat, mat2, by.y = "Var1", by.x = "ID")
# Use a for loop to calculate biomass per tree based on the average dbh of dominant and codominant trees for the most common species in each raster cell:
merge$CONBM_tree_kg <- 0
merge$CONBM_kg <- 0
merge$relNO <- 0
merge$sumBA <- 0
for (i in 1:nrow(merge)) {
cell <- merge[i,]
if (cell$CONPLBA %in% Cedars) { #CONPLBA = Conifer tree species with plurality of basal area
num <- (B0[1] + B1[1]*log(cell$QMDC_DOM)) # apply formula above, minus the exp. QMDC_DOM = Quadratic mean diameter of all dominant and codominant conifers
} else if (cell$CONPLBA %in% Dougfirs) {
num <- (B0[2] + B1[2]*log(cell$QMDC_DOM))
} else if (cell$CONPLBA %in% Firs) {
num <- (B0[3] + B1[3]*log(cell$QMDC_DOM))
} else if (cell$CONPLBA %in% Pines) {
num <- (B0[4] + B1[4]*log(cell$QMDC_DOM))
} else if (cell$CONPLBA %in% Spruces) {
num <- (B0[5] + B1[5]*log(cell$QMDC_DOM))
} else {
num <- 0
}
if (num == 0) {
merge[i,]$CONBM_tree_kg <- 0 # assign 0 if no conifers
} else {
merge[i,]$CONBM_tree_kg <- exp(num) # finish the formula
}
merge[i,]$sumBA <- cell$BAC_GE_3*cell$Freq.x
}
totBA <- sum(merge$sumBA)
merge$relBA <- merge$sumBA/totBA
tot_NO <- single@data$NO_TREE
merge$relNO <- tot_NO*merge$relBA
merge$CONBM_kg <- merge$relNO*merge$CONBM_tree_kg
CONBM_kg_pol <- sum(merge$CONBM_kg)
Av_BM_TR <- CONBM_kg_pol/tot_NO
QMDC_DOM <- mean(merge$QMDC_DOM)
CONPL <-  names(tail(sort(summary(merge$CONPLBA)), n=1))
TOT_CONBM_kgha <- sum(merge$BPHC_GE_3_CRM*merge$Freq.y) # BPHC_GE_3_CRM is estimated biomass of all conifers
CON_THA <- sum(merge$TPHC_GE_3*merge$Freq.y)
final <- cbind(single@data$RPT_YR,single@data$TPA,single@data$NO_TREE,single@data$FOR_TYP,single@data$Shap_Ar,TOT_CONBM_kgha, CON_THA, QMDC_DOM, CONPL, Av_BM_TR, CONBM_kg_pol,gCentroid(single)@coords)
final <- as.data.frame(final)
final$est.tot.con <- (single@data$Shap_Ar/10000)*CON_THA
final$est.tot.con.BM <- (single@data$Shap_Ar/10000)*TOT_CONBM_kgha
result.lemma <- rbind(final, result.lemma)
}
names(result.lemma)[names(result.lemma)=="V1"] <- "RPT_YR"
names(result.lemma)[names(result.lemma)=="V2"] <- "TPA"
names(result.lemma)[names(result.lemma)=="V3"] <- "NO_TREE"
names(result.lemma)[names(result.lemma)=="V4"] <- "FOR_TYP"
names(result.lemma)[names(result.lemma)=="V5"] <- "Shap_Ar"
names(result.lemma)[names(result.lemma)=="x"] <- "Cent.x"
names(result.lemma)[names(result.lemma)=="y"] <- "Cent.y"
head(result.lemma)
merge
totBA <- sum(merge$sumBA)
merge$relBA <- merge$sumBA/totBA
tot_NO <- single@data$NO_TREE
merge$relNO <- tot_NO*merge$relBA
merge$CONBM_kg <- merge$relNO*merge$CONBM_tree_kg
CONBM_kg_pol <- sum(merge$CONBM_kg)
Av_BM_TR <- CONBM_kg_pol/tot_NO
QMDC_DOM <- mean(merge$QMDC_DOM)
CONPL <-  names(tail(sort(summary(merge$CONPLBA)), n=1))
TOT_CONBM_kgha <- sum(merge$BPHC_GE_3_CRM*merge$Freq.y) # BPHC_GE_3_CRM is estimated biomass of all conifers
CON_THA <- sum(merge$TPHC_GE_3*merge$Freq.y)
sum(merge$relBA)
sum(merge$relNO)
CONBM_kg_pol
CONBM_kg_pol/78
cell <- merge[10,]
if (cell$CONPLBA %in% Cedars) { #CONPLBA = Conifer tree species with plurality of basal area
num <- (B0[1] + B1[1]*log(cell$QMDC_DOM)) # apply formula above, minus the exp. QMDC_DOM = Quadratic mean diameter of all dominant and codominant conifers
} else if (cell$CONPLBA %in% Dougfirs) {
num <- (B0[2] + B1[2]*log(cell$QMDC_DOM))
} else if (cell$CONPLBA %in% Firs) {
num <- (B0[3] + B1[3]*log(cell$QMDC_DOM))
} else if (cell$CONPLBA %in% Pines) {
num <- (B0[4] + B1[4]*log(cell$QMDC_DOM))
} else if (cell$CONPLBA %in% Spruces) {
num <- (B0[5] + B1[5]*log(cell$QMDC_DOM))
} else {
num <- 0
}
num
Dougfirs <- c("PSMA", "PSME") # all have been checked for genus plants.usda.gov
if (cell$CONPLBA %in% Cedars) { #CONPLBA = Conifer tree species with plurality of basal area
num <- (B0[1] + B1[1]*log(cell$QMDC_DOM)) # apply formula above, minus the exp. QMDC_DOM = Quadratic mean diameter of all dominant and codominant conifers
} else if (cell$CONPLBA %in% Dougfirs) {
num <- (B0[2] + B1[2]*log(cell$QMDC_DOM))
} else if (cell$CONPLBA %in% Firs) {
num <- (B0[3] + B1[3]*log(cell$QMDC_DOM))
} else if (cell$CONPLBA %in% Pines) {
num <- (B0[4] + B1[4]*log(cell$QMDC_DOM))
} else if (cell$CONPLBA %in% Spruces) {
num <- (B0[5] + B1[5]*log(cell$QMDC_DOM))
} else {
num <- 0
}
if (num == 0) {
merge[i,]$CONBM_tree_kg <- 0 # assign 0 if no conifers
} else {
merge[i,]$CONBM_tree_kg <- exp(num) # finish the formula
}
merge
num
single
clip1 <- crop(LEMMA, extent(single))
clip2 <- mask(clip1, single)
ext <- extract(clip2, single) # extracts data from the raster - this value is the plot # of the raster cell, which corresponds to detailed data in the attribute table
tab <- lapply(ext, table) # creates a table that counts how many of each raster value there are in the polygon
s <- sum(tab[[1]]) # Counts total raster cells the polygon - this is different from length(clip2tg) because it doesn't include NAs
mat <- as.data.frame(tab)
mat2 <- as.data.frame(tab[[1]]/s) # Gives fraction of polygon occupied by each plot type. Adds up to 1 for each polygon.
mat2 <- merge(mat, mat2, by="Var1")
# extract attribute information from LEMMA for each plot number contained in the polygon:
L.in.mat <- subset(LEMMA@data@attributes[[1]], LEMMA@data@attributes[[1]][,"ID"] %in% mat[,1])[,c("ID","BAC_GE_3","BPHC_GE_3_CRM","TPHC_GE_3","QMDC_DOM","CONPLBA","TREEPLBA")]
# SKIP POLYGONS WITH NO CORRESPONDING RASTER DATA
if (is.na(L.in.mat[1,1])) {
next
}
merge <- merge(L.in.mat, mat2, by.y = "Var1", by.x = "ID")
# Use a for loop to calculate biomass per tree based on the average dbh of dominant and codominant trees for the most common species in each raster cell:
merge$CONBM_tree_kg <- 0
merge$CONBM_kg <- 0
merge$relNO <- 0
merge$sumBA <- 0
for (i in 1:nrow(merge)) {
cell <- merge[i,]
if (cell$CONPLBA %in% Cedars) { #CONPLBA = Conifer tree species with plurality of basal area
num <- (B0[1] + B1[1]*log(cell$QMDC_DOM)) # apply formula above, minus the exp. QMDC_DOM = Quadratic mean diameter of all dominant and codominant conifers
} else if (cell$CONPLBA %in% Dougfirs) {
num <- (B0[2] + B1[2]*log(cell$QMDC_DOM))
} else if (cell$CONPLBA %in% Firs) {
num <- (B0[3] + B1[3]*log(cell$QMDC_DOM))
} else if (cell$CONPLBA %in% Pines) {
num <- (B0[4] + B1[4]*log(cell$QMDC_DOM))
} else if (cell$CONPLBA %in% Spruces) {
num <- (B0[5] + B1[5]*log(cell$QMDC_DOM))
} else {
num <- 0
}
if (num == 0) {
merge[i,]$CONBM_tree_kg <- 0 # assign 0 if no conifers
} else {
merge[i,]$CONBM_tree_kg <- exp(num) # finish the formula
}
merge[i,]$sumBA <- cell$BAC_GE_3*cell$Freq.x
}
totBA <- sum(merge$sumBA)
merge$relBA <- merge$sumBA/totBA
tot_NO <- single@data$NO_TREE
merge$relNO <- tot_NO*merge$relBA
merge$CONBM_kg <- merge$relNO*merge$CONBM_tree_kg
CONBM_kg_pol <- sum(merge$CONBM_kg)
Av_BM_TR <- CONBM_kg_pol/tot_NO
QMDC_DOM <- mean(merge$QMDC_DOM)
CONPL <-  names(tail(sort(summary(merge$CONPLBA)), n=1))
TOT_CONBM_kgha <- sum(merge$BPHC_GE_3_CRM*merge$Freq.y) # BPHC_GE_3_CRM is estimated biomass of all conifers
CON_THA <- sum(merge$TPHC_GE_3*merge$Freq.y)
final <- cbind(single@data$RPT_YR,single@data$TPA,single@data$NO_TREE,single@data$FOR_TYP,single@data$Shap_Ar,TOT_CONBM_kgha, CON_THA, QMDC_DOM, CONPL, Av_BM_TR, CONBM_kg_pol,gCentroid(single)@coords)
final <- as.data.frame(final)
final$est.tot.con <- (single@data$Shap_Ar/10000)*CON_THA
final$est.tot.con.BM <- (single@data$Shap_Ar/10000)*TOT_CONBM_kgha
final
merge
Av_BM_TR
result.lemma <- data.frame()
for (i in 77:78) { # final: nrow(drought)
single <- drought[i,]
clip1 <- crop(LEMMA, extent(single))
clip2 <- mask(clip1, single)
ext <- extract(clip2, single) # extracts data from the raster - this value is the plot # of the raster cell, which corresponds to detailed data in the attribute table
tab <- lapply(ext, table) # creates a table that counts how many of each raster value there are in the polygon
s <- sum(tab[[1]]) # Counts total raster cells the polygon - this is different from length(clip2tg) because it doesn't include NAs
mat <- as.data.frame(tab)
mat2 <- as.data.frame(tab[[1]]/s) # Gives fraction of polygon occupied by each plot type. Adds up to 1 for each polygon.
mat2 <- merge(mat, mat2, by="Var1")
# extract attribute information from LEMMA for each plot number contained in the polygon:
L.in.mat <- subset(LEMMA@data@attributes[[1]], LEMMA@data@attributes[[1]][,"ID"] %in% mat[,1])[,c("ID","BAC_GE_3","BPHC_GE_3_CRM","TPHC_GE_3","QMDC_DOM","CONPLBA","TREEPLBA")]
# SKIP POLYGONS WITH NO CORRESPONDING RASTER DATA
if (is.na(L.in.mat[1,1])) {
next
}
merge <- merge(L.in.mat, mat2, by.y = "Var1", by.x = "ID")
# Use a for loop to calculate biomass per tree based on the average dbh of dominant and codominant trees for the most common species in each raster cell:
merge$CONBM_tree_kg <- 0
merge$CONBM_kg <- 0
merge$relNO <- 0
merge$sumBA <- 0
for (i in 1:nrow(merge)) {
cell <- merge[i,]
if (cell$CONPLBA %in% Cedars) { #CONPLBA = Conifer tree species with plurality of basal area
num <- (B0[1] + B1[1]*log(cell$QMDC_DOM)) # apply formula above, minus the exp. QMDC_DOM = Quadratic mean diameter of all dominant and codominant conifers
} else if (cell$CONPLBA %in% Dougfirs) {
num <- (B0[2] + B1[2]*log(cell$QMDC_DOM))
} else if (cell$CONPLBA %in% Firs) {
num <- (B0[3] + B1[3]*log(cell$QMDC_DOM))
} else if (cell$CONPLBA %in% Pines) {
num <- (B0[4] + B1[4]*log(cell$QMDC_DOM))
} else if (cell$CONPLBA %in% Spruces) {
num <- (B0[5] + B1[5]*log(cell$QMDC_DOM))
} else {
num <- 0
}
if (num == 0) {
merge[i,]$CONBM_tree_kg <- 0 # assign 0 if no conifers
} else {
merge[i,]$CONBM_tree_kg <- exp(num) # finish the formula
}
merge[i,]$sumBA <- cell$BAC_GE_3*cell$Freq.x
}
totBA <- sum(merge$sumBA)
merge$relBA <- merge$sumBA/totBA
tot_NO <- single@data$NO_TREE
merge$relNO <- tot_NO*merge$relBA
merge$CONBM_kg <- merge$relNO*merge$CONBM_tree_kg
CONBM_kg_pol <- sum(merge$CONBM_kg)
Av_BM_TR <- CONBM_kg_pol/tot_NO
QMDC_DOM <- mean(merge$QMDC_DOM)
CONPL <-  names(tail(sort(summary(merge$CONPLBA)), n=1))
TOT_CONBM_kgha <- sum(merge$BPHC_GE_3_CRM*merge$Freq.y) # BPHC_GE_3_CRM is estimated biomass of all conifers
CON_THA <- sum(merge$TPHC_GE_3*merge$Freq.y)
final <- cbind(single@data$RPT_YR,single@data$TPA,single@data$NO_TREE,single@data$FOR_TYP,single@data$Shap_Ar,TOT_CONBM_kgha, CON_THA, QMDC_DOM, CONPL, Av_BM_TR, CONBM_kg_pol,gCentroid(single)@coords)
final <- as.data.frame(final)
final$est.tot.con <- (single@data$Shap_Ar/10000)*CON_THA
final$est.tot.con.BM <- (single@data$Shap_Ar/10000)*TOT_CONBM_kgha
result.lemma <- rbind(final, result.lemma)
}
names(result.lemma)[names(result.lemma)=="V1"] <- "RPT_YR"
names(result.lemma)[names(result.lemma)=="V2"] <- "TPA"
names(result.lemma)[names(result.lemma)=="V3"] <- "NO_TREE"
names(result.lemma)[names(result.lemma)=="V4"] <- "FOR_TYP"
names(result.lemma)[names(result.lemma)=="V5"] <- "Shap_Ar"
names(result.lemma)[names(result.lemma)=="x"] <- "Cent.x"
names(result.lemma)[names(result.lemma)=="y"] <- "Cent.y"
head(result.lemma)
drought.s
setwd("C:/Users/Carmen/Box Sync/EPIC-Biomass/GIS Data/tempdir")
#writeRaster(CR_mort, filename = "CR_mort.tif", format = "GTiff", overwrite = TRUE) # save a backup
CR_mort <- raster("CR_mort.tif")
drought.s <- crop(drought, extent(CR_mort))
drought.s <- subset(drought.s, drought.s$ACRES >2)
result.lemma <- data.frame()
for (i in 1:nrow(drought.s)) { # final: nrow(drought)
single <- drought[i,]
clip1 <- crop(LEMMA, extent(single))
clip2 <- mask(clip1, single)
ext <- extract(clip2, single) # extracts data from the raster - this value is the plot # of the raster cell, which corresponds to detailed data in the attribute table
tab <- lapply(ext, table) # creates a table that counts how many of each raster value there are in the polygon
s <- sum(tab[[1]]) # Counts total raster cells the polygon - this is different from length(clip2tg) because it doesn't include NAs
mat <- as.data.frame(tab)
mat2 <- as.data.frame(tab[[1]]/s) # Gives fraction of polygon occupied by each plot type. Adds up to 1 for each polygon.
mat2 <- merge(mat, mat2, by="Var1")
# extract attribute information from LEMMA for each plot number contained in the polygon:
L.in.mat <- subset(LEMMA@data@attributes[[1]], LEMMA@data@attributes[[1]][,"ID"] %in% mat[,1])[,c("ID","BAC_GE_3","BPHC_GE_3_CRM","TPHC_GE_3","QMDC_DOM","CONPLBA","TREEPLBA")]
# SKIP POLYGONS WITH NO CORRESPONDING RASTER DATA
if (is.na(L.in.mat[1,1])) {
next
}
merge <- merge(L.in.mat, mat2, by.y = "Var1", by.x = "ID")
# Use a for loop to calculate biomass per tree based on the average dbh of dominant and codominant trees for the most common species in each raster cell:
merge$CONBM_tree_kg <- 0
merge$CONBM_kg <- 0
merge$relNO <- 0
merge$sumBA <- 0
for (i in 1:nrow(merge)) {
cell <- merge[i,]
if (cell$CONPLBA %in% Cedars) { #CONPLBA = Conifer tree species with plurality of basal area
num <- (B0[1] + B1[1]*log(cell$QMDC_DOM)) # apply formula above, minus the exp. QMDC_DOM = Quadratic mean diameter of all dominant and codominant conifers
} else if (cell$CONPLBA %in% Dougfirs) {
num <- (B0[2] + B1[2]*log(cell$QMDC_DOM))
} else if (cell$CONPLBA %in% Firs) {
num <- (B0[3] + B1[3]*log(cell$QMDC_DOM))
} else if (cell$CONPLBA %in% Pines) {
num <- (B0[4] + B1[4]*log(cell$QMDC_DOM))
} else if (cell$CONPLBA %in% Spruces) {
num <- (B0[5] + B1[5]*log(cell$QMDC_DOM))
} else {
num <- 0
}
if (num == 0) {
merge[i,]$CONBM_tree_kg <- 0 # assign 0 if no conifers
} else {
merge[i,]$CONBM_tree_kg <- exp(num) # finish the formula
}
merge[i,]$sumBA <- cell$BAC_GE_3*cell$Freq.x
}
totBA <- sum(merge$sumBA)
merge$relBA <- merge$sumBA/totBA
tot_NO <- single@data$NO_TREE
merge$relNO <- tot_NO*merge$relBA
merge$CONBM_kg <- merge$relNO*merge$CONBM_tree_kg
CONBM_kg_pol <- sum(merge$CONBM_kg)
Av_BM_TR <- CONBM_kg_pol/tot_NO
QMDC_DOM <- mean(merge$QMDC_DOM)
CONPL <-  names(tail(sort(summary(merge$CONPLBA)), n=1))
TOT_CONBM_kgha <- sum(merge$BPHC_GE_3_CRM*merge$Freq.y) # BPHC_GE_3_CRM is estimated biomass of all conifers
CON_THA <- sum(merge$TPHC_GE_3*merge$Freq.y)
final <- cbind(single@data$RPT_YR,single@data$TPA,single@data$NO_TREE,single@data$FOR_TYP,single@data$Shap_Ar,TOT_CONBM_kgha, CON_THA, QMDC_DOM, CONPL, Av_BM_TR, CONBM_kg_pol,gCentroid(single)@coords)
final <- as.data.frame(final)
final$est.tot.con <- (single@data$Shap_Ar/10000)*CON_THA
final$est.tot.con.BM <- (single@data$Shap_Ar/10000)*TOT_CONBM_kgha
result.lemma <- rbind(final, result.lemma)
}
names(result.lemma)[names(result.lemma)=="V1"] <- "RPT_YR"
names(result.lemma)[names(result.lemma)=="V2"] <- "TPA"
names(result.lemma)[names(result.lemma)=="V3"] <- "NO_TREE"
names(result.lemma)[names(result.lemma)=="V4"] <- "FOR_TYP"
names(result.lemma)[names(result.lemma)=="V5"] <- "Shap_Ar"
names(result.lemma)[names(result.lemma)=="x"] <- "Cent.x"
names(result.lemma)[names(result.lemma)=="y"] <- "Cent.y"
head(result.lemma)
# CLEAR EVERYTHING IN LOOPS
remove(cell, final, L.in.mat, mat, mat2, merge)
remove(BM_eqns, BA, BM, clip1, clip2, CONPL, CONPL2, CONPL3, CONPLR, CONPLR2, CONPLR3)
remove(num, numcon, s, ext, i, tab, single, THA, TREEPL, TREEPLR, QMDC_DOM, Av_BM_TR, CONBM_kgha, CONBM_kg_pol, relNO, NO)
result.lemma.drought.s <- result.lemma
setwd("C:/Users/Carmen/cec_apl/Biomass/Results")
write.csv(result.lemma.drought.s, file = "Trial_Biomass_Polygons_LEMMA_3.csv", row.names=F)
View(result.lemma)
cell
single <- drought[77,]
clip1 <- crop(LEMMA, extent(single))
clip2 <- mask(clip1, single)
ext <- extract(clip2, single) # extracts data from the raster - this value is the plot # of the raster cell, which corresponds to detailed data in the attribute table
tab <- lapply(ext, table) # creates a table that counts how many of each raster value there are in the polygon
s <- sum(tab[[1]]) # Counts total raster cells the polygon - this is different from length(clip2tg) because it doesn't include NAs
mat <- as.data.frame(tab)
mat2 <- as.data.frame(tab[[1]]/s) # Gives fraction of polygon occupied by each plot type. Adds up to 1 for each polygon.
mat2 <- merge(mat, mat2, by="Var1")
# extract attribute information from LEMMA for each plot number contained in the polygon:
L.in.mat <- subset(LEMMA@data@attributes[[1]], LEMMA@data@attributes[[1]][,"ID"] %in% mat[,1])[,c("ID","BAC_GE_3","BPHC_GE_3_CRM","TPHC_GE_3","QMDC_DOM","CONPLBA","TREEPLBA")]
# SKIP POLYGONS WITH NO CORRESPONDING RASTER DATA
if (is.na(L.in.mat[1,1])) {
next
}
merge <- merge(L.in.mat, mat2, by.y = "Var1", by.x = "ID")
# Use a for loop to calculate biomass per tree based on the average dbh of dominant and codominant trees for the most common species in each raster cell:
merge$CONBM_tree_kg <- 0
merge$CONBM_kg <- 0
merge$relNO <- 0
merge$sumBA <- 0
for (i in 1:nrow(merge)) {
cell <- merge[i,]
if (cell$CONPLBA %in% Cedars) { #CONPLBA = Conifer tree species with plurality of basal area
num <- (B0[1] + B1[1]*log(cell$QMDC_DOM)) # apply formula above, minus the exp. QMDC_DOM = Quadratic mean diameter of all dominant and codominant conifers
} else if (cell$CONPLBA %in% Dougfirs) {
num <- (B0[2] + B1[2]*log(cell$QMDC_DOM))
} else if (cell$CONPLBA %in% Firs) {
num <- (B0[3] + B1[3]*log(cell$QMDC_DOM))
} else if (cell$CONPLBA %in% Pines) {
num <- (B0[4] + B1[4]*log(cell$QMDC_DOM))
} else if (cell$CONPLBA %in% Spruces) {
num <- (B0[5] + B1[5]*log(cell$QMDC_DOM))
} else {
num <- 0
}
if (num == 0) {
merge[i,]$CONBM_tree_kg <- 0 # assign 0 if no conifers
} else {
merge[i,]$CONBM_tree_kg <- exp(num) # finish the formula
}
merge[i,]$sumBA <- cell$BAC_GE_3*cell$Freq.x
}
totBA <- sum(merge$sumBA)
merge$relBA <- merge$sumBA/totBA
tot_NO <- single@data$NO_TREE
merge$relNO <- tot_NO*merge$relBA
merge$CONBM_kg <- merge$relNO*merge$CONBM_tree_kg
CONBM_kg_pol <- sum(merge$CONBM_kg)
Av_BM_TR <- CONBM_kg_pol/tot_NO
QMDC_DOM <- mean(merge$QMDC_DOM)
CONPL <-  names(tail(sort(summary(merge$CONPLBA)), n=1))
TOT_CONBM_kgha <- sum(merge$BPHC_GE_3_CRM*merge$Freq.y) # BPHC_GE_3_CRM is estimated biomass of all conifers
CON_THA <- sum(merge$TPHC_GE_3*merge$Freq.y)
final <- cbind(single@data$RPT_YR,single@data$TPA,single@data$NO_TREE,single@data$FOR_TYP,single@data$Shap_Ar,TOT_CONBM_kgha, CON_THA, QMDC_DOM, CONPL, Av_BM_TR, CONBM_kg_pol,gCentroid(single)@coords)
final <- as.data.frame(final)
final$est.tot.con <- (single@data$Shap_Ar/10000)*CON_THA
final$est.tot.con.BM <- (single@data$Shap_Ar/10000)*TOT_CONBM_kgha
cel
cell
clip2
coordinates(clip2)
ext
plot(cip2)
plot(clip2)
clip2@data
q
clip2@data@values
pcoords <- merge(clip2@data@values, coordinates(clip2))
pcoords
pcoords <- cbind(clip2@data@values, coordinates(clip2))
pcoords
merge
View(merge)
pcoords <- as.data.frame(pcoords)
pcoords
merge(merge, pcoords, by.x ="ID", by.y <- "v1")
merge(merge, pcoords, by.x ="ID", by.y = "v1")
merge(merge, pcoords, by.x ="ID", by.y = "V1")
View(merge)
pmerge <- merge(merge, pcoords, by.x ="ID", by.y = "V1")
View(pmerge)
nrow(pmerge)
clip1 <- crop(LEMMA, extent(single))
clip2 <- mask(clip1, single)
pcoords <- cbind(clip2@data@values, coordinates(clip2))
pcoords <- as.data.frame(pcoords)
ext <- extract(clip2, single) # extracts data from the raster - this value is the plot # of the raster cell, which corresponds to detailed data in the attribute table
tab <- lapply(ext, table) # creates a table that counts how many of each raster value there are in the polygon
s <- sum(tab[[1]]) # Counts total raster cells the polygon - this is different from length(clip2tg) because it doesn't include NAs
mat <- as.data.frame(tab)
mat2 <- as.data.frame(tab[[1]]/s) # Gives fraction of polygon occupied by each plot type. Adds up to 1 for each polygon.
mat2 <- merge(mat, mat2, by="Var1")
# extract attribute information from LEMMA for each plot number contained in the polygon:
L.in.mat <- subset(LEMMA@data@attributes[[1]], LEMMA@data@attributes[[1]][,"ID"] %in% mat[,1])[,c("ID","BAC_GE_3","BPHC_GE_3_CRM","TPHC_GE_3","QMDC_DOM","CONPLBA","TREEPLBA")]
# SKIP POLYGONS WITH NO CORRESPONDING RASTER DATA
if (is.na(L.in.mat[1,1])) {
next
}
merge <- merge(L.in.mat, mat2, by.y = "Var1", by.x = "ID")
# Use a for loop to calculate biomass per tree based on the average dbh of dominant and codominant trees for the most common species in each raster cell:
merge$CONBM_tree_kg <- 0
merge$CONBM_kg <- 0
merge$relNO <- 0
merge$sumBA <- 0
for (i in 1:nrow(merge)) {
cell <- merge[i,]
if (cell$CONPLBA %in% Cedars) { #CONPLBA = Conifer tree species with plurality of basal area
num <- (B0[1] + B1[1]*log(cell$QMDC_DOM)) # apply formula above, minus the exp. QMDC_DOM = Quadratic mean diameter of all dominant and codominant conifers
} else if (cell$CONPLBA %in% Dougfirs) {
num <- (B0[2] + B1[2]*log(cell$QMDC_DOM))
} else if (cell$CONPLBA %in% Firs) {
num <- (B0[3] + B1[3]*log(cell$QMDC_DOM))
} else if (cell$CONPLBA %in% Pines) {
num <- (B0[4] + B1[4]*log(cell$QMDC_DOM))
} else if (cell$CONPLBA %in% Spruces) {
num <- (B0[5] + B1[5]*log(cell$QMDC_DOM))
} else {
num <- 0
}
if (num == 0) {
merge[i,]$CONBM_tree_kg <- 0 # assign 0 if no conifers
} else {
merge[i,]$CONBM_tree_kg <- exp(num) # finish the formula
}
merge[i,]$sumBA <- cell$BAC_GE_3*cell$Freq.x
}
pmerge <- merge(merge, pcoords, by.x ="ID", by.y = "V1")
nrow(pmerge)
head(pmerge)
tail(pmerge)
totBA <- sum(pmerge$sumBA)
pmerge$relBA <- pmerge$sumBA/totBA
sum(pmerge$relBA)
tot_NO <- single@data$NO_TREE
pmerge$relNO <- tot_NO*pmerge$relBA
sum(pmerge$relNO)
pmerge$CONBM_kg <- pmerge$relNO*pmerge$CONBM_tree_kg
CONBM_kg_pol <- sum(pmerge$CONBM_kg)
Av_BM_TR <- CONBM_kg_pol/tot_NO
QMDC_DOM <- mean(pmerge$QMDC_DOM)
CONPL <-  names(tail(sort(summary(pmerge$CONPLBA)), n=1))
CONPL
pmerge
TOT_CONBM_kgha <- mean(pmerge$BPHC_GE_3_CRM) # BPHC_GE_3_CRM is estimated biomass of all conifers
CON_THA <- mean(pmerge$TPHC_GE_3)
final <- cbind(pmerge, single@data$RPT_YR,single@data$TPA,single@data$NO_TREE,single@data$FOR_TYP,single@data$Shap_Ar,TOT_CONBM_kgha, CON_THA, QMDC_DOM, CONPL, Av_BM_TR, CONBM_kg_pol,gCentroid(single)@coords)
library(RPostgreSQL)
dbConnect(drv = dbDriver('PostgreSQL'), user = "ctubbesing", dbname = "apl_cec sslmode=require", host = "switch-db2.erg.berkeley.edu",  password = "biomass123")
dbConnect(drv = dbDriver('PostgreSQL'), user = "ctubbesing", dbname = "dbname=apl_cec sslmode=require", host = "switch-db2.erg.berkeley.edu",  password = "biomass123")
install.packages("RJDBC")
library(RJDBC)
jdbcDriver <- JDBC(driverClass="org.postgresql.Driver")
jdbcDriver <- JDBC(driverClass="org.postgresql.Driver", classPath="C:/Users/Carmen/cec_apl/)
q
q
qqq
qqq
""
)
jdbcDriver <- JDBC(driverClass="org.postgresql.Driver", classPath="C:/Users/Carmen/cec_apl/")
library(RJDBC)
install.packages("rjava")
install.packages("rJava")
library(rJava)
library(rJava)
library(rJava)
install.packages("rJava")
library(rJava)
jdbcDriver <- JDBC(driverClass="org.postgresql.Driver", classPath="C:/Users/Carmen/cec_apl/")
